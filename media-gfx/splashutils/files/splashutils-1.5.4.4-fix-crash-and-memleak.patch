From 6ac4695e341c5a0b5f4a82aea85d3b42dc54d900 Mon Sep 17 00:00:00 2001
From: "i.Dark_Templar" <darktemplar@dark-templar-archives.net>
Date: Sun, 7 Apr 2019 18:14:14 +0300
Subject: [PATCH] Fix crash and memory leak

---
 src/libfbsplashrender.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/libfbsplashrender.c b/src/libfbsplashrender.c
index bebce95..e046fc4 100644
--- a/src/libfbsplashrender.c
+++ b/src/libfbsplashrender.c
@@ -384,7 +384,7 @@ int fbsplashr_render_buf(struct fbspl_theme *theme, void *buffer, bool repaint)
  */
 int fbsplashr_render_screen(struct fbspl_theme *theme, bool repaint, bool bgnd, char effects)
 {
-	if (!fbsplashr_render_buf(theme, theme->bgbuf, repaint)) {
+	if (theme && (!fbsplashr_render_buf(theme, theme->bgbuf, repaint))) {
 		if (repaint) {
 			if (effects & FBSPL_EFF_FADEIN) {
 				fade(theme, fb_mem, theme->bgbuf, theme->silent_img.cmap, bgnd ? 1 : 0, fd_fb, 0);
@@ -438,7 +438,10 @@ struct fbspl_theme *fbsplashr_theme_load()
 
 	fbsplash_get_res(config.theme, &st->xres, &st->yres);
 	if (st->xres == 0 || st->yres == 0)
+	{
+		free(st);
 		return NULL;
+	}
 
 	snprintf(buf, 512, FBSPL_THEME_DIR "/%s/%dx%d.cfg", config.theme, st->xres, st->yres);
 
-- 
2.21.0

