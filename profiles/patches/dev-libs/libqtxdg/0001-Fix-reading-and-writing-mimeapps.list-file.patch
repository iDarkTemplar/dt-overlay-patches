From 96c3678527ba33fd53040dabd09909b3a02d4fa0 Mon Sep 17 00:00:00 2001
From: "i.Dark_Templar" <darktemplar@dark-templar-archives.net>
Date: Sat, 30 Sep 2017 20:02:49 +0300
Subject: [PATCH 1/2] Fix reading and writing mimeapps.list file.

---
 qtxdg/xdgdesktopfile.cpp | 25 ++++++++++++++++++++++---
 1 file changed, 22 insertions(+), 3 deletions(-)

diff --git a/qtxdg/xdgdesktopfile.cpp b/qtxdg/xdgdesktopfile.cpp
index d21e2df..56d42da 100644
--- a/qtxdg/xdgdesktopfile.cpp
+++ b/qtxdg/xdgdesktopfile.cpp
@@ -1396,7 +1396,7 @@ bool readDesktopFile(QIODevice & device, QSettings::SettingsMap & map)
 
         if (value.contains(QLatin1Char(';')))
         {
-            map.insert(key, value.split(QLatin1Char(';')));
+            map.insert(key, value.split(QLatin1Char(';'), QString::SplitBehavior::SkipEmptyParts));
         }
         else
         {
@@ -1418,7 +1418,10 @@ bool writeDesktopFile(QIODevice & device, const QSettings::SettingsMap & map)
 
     for (auto it = map.constBegin(); it != map.constEnd(); ++it)
     {
-        if (! it.value().canConvert<QString>())
+        bool isString     = it.value().canConvert<QString>();
+        bool isStringList = (it.value().type() == QVariant::Type::StringList);
+
+        if ((! isString) && (! isStringList))
         {
             return false;
         }
@@ -1444,7 +1447,23 @@ bool writeDesktopFile(QIODevice & device, const QSettings::SettingsMap & map)
             return false;
         }
 
-        stream << remainingKey << QLatin1Char('=') << it.value().toString() << QLatin1Char('\n');
+        stream << remainingKey << QLatin1Char('=');
+
+        if (isString)
+        {
+            stream << it.value().toString() << QLatin1Char(';');
+        }
+        else /* if (isStringList) */
+        {
+            const auto &valueList = it.value().toStringList();
+
+            for (auto valueIt = valueList.constBegin(); valueIt != valueList.end(); ++valueIt)
+            {
+                stream << (*valueIt) << QLatin1Char(';');
+            }
+        }
+
+        stream << QLatin1Char('\n');
 
     }
 
-- 
2.13.6

