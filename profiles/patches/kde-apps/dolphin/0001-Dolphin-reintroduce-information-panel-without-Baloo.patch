From 46e03d10bca59eb5ad9c238a9a7f541511fdd6d4 Mon Sep 17 00:00:00 2001
From: "i.Dark_Templar" <darktemplar@dark-templar-archives.net>
Date: Sat, 30 Mar 2019 18:38:24 +0300
Subject: [PATCH 1/3] Dolphin: reintroduce information panel without Baloo

This panel is unconfigurable and contains only preview
---
 CMakeLists.txt                                | 10 ++---
 src/CMakeLists.txt                            | 37 +++++++------------
 src/dolphinmainwindow.cpp                     |  6 ---
 src/dolphinmainwindow.h                       |  2 -
 src/panels/information/informationpanel.cpp   |  7 ++++
 .../information/informationpanelcontent.cpp   | 35 ++++++++++++++++++
 .../information/informationpanelcontent.h     |  4 ++
 7 files changed, 64 insertions(+), 37 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 63502a7cf..51842e430 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -136,15 +136,15 @@ set_package_properties(KF6BalooWidgets PROPERTIES DESCRIPTION "Baloos Widgets"
 if (KF6Baloo_FOUND AND KF6BalooWidgets_FOUND)
     message(STATUS "Baloo packages are found")
     set(HAVE_BALOO TRUE)
-
-    find_package(Qt6 ${QT_MIN_VERSION} CONFIG REQUIRED COMPONENTS
-        Multimedia
-        MultimediaWidgets
-    )
 else ()
     message(WARNING "Baloo packages not found. They are needed for the metadata features of Dolphin (including the information panel).")
 endif()
 
+find_package(Qt6 ${QT_MIN_VERSION} CONFIG REQUIRED COMPONENTS
+    Multimedia
+    MultimediaWidgets
+)
+
 # TODO: drop HAVE_TERMINAL once we are sure the terminal panel works on Windows too.
 if(WIN32)
     set(HAVE_TERMINAL FALSE)
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 6e982fce8..bbecc49e6 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -216,6 +216,8 @@ target_link_libraries(
     Qt6::Concurrent
     Qt6::DBus
     Qt6::Gui
+    Qt6::Multimedia
+    Qt6::MultimediaWidgets
     KF6::I18n
     KF6::GuiAddons
     KF6::IconThemes
@@ -302,6 +304,10 @@ target_sources(dolphinstatic PRIVATE
     trash/dolphintrash.cpp
     filterbar/filterbar.cpp
     kitemviews/kfileitemlisttostring.cpp
+    panels/information/informationpanel.cpp
+    panels/information/informationpanelcontent.cpp
+    panels/information/pixmapviewer.cpp
+    panels/information/mediawidget.cpp
     panels/places/placespanel.cpp
     panels/panel.cpp
     panels/folders/foldersitemlistwidget.cpp
@@ -329,6 +335,7 @@ target_sources(dolphinstatic PRIVATE
     settings/interface/confirmationssettingspage.cpp
     settings/interface/interfacesettingspage.cpp
     settings/interface/previewssettingspage.cpp
+    settings/interface/panelsettingspage.cpp
     settings/dolphinsettingsdialog.cpp
     settings/contextmenu/contextmenusettingspage.cpp
     settings/settingspagebase.cpp
@@ -371,6 +378,10 @@ target_sources(dolphinstatic PRIVATE
     trash/dolphintrash.h
     filterbar/filterbar.h
     kitemviews/kfileitemlisttostring.h
+    panels/information/informationpanel.h
+    panels/information/informationpanelcontent.h
+    panels/information/pixmapviewer.h
+    panels/information/mediawidget.h
     panels/places/placespanel.h
     panels/panel.h
     panels/folders/foldersitemlistwidget.h
@@ -398,6 +409,7 @@ target_sources(dolphinstatic PRIVATE
     settings/interface/confirmationssettingspage.h
     settings/interface/interfacesettingspage.h
     settings/interface/previewssettingspage.h
+    settings/interface/panelsettingspage.h
     settings/dolphinsettingsdialog.h
     settings/contextmenu/contextmenusettingspage.h
     settings/settingspagebase.h
@@ -420,30 +432,6 @@ target_sources(dolphinstatic PRIVATE
     global.h
 )
 
-if(HAVE_BALOO)
-    target_sources(dolphinstatic PRIVATE
-        panels/information/informationpanel.cpp
-        panels/information/informationpanelcontent.cpp
-        panels/information/pixmapviewer.cpp
-        panels/information/mediawidget.cpp
-        settings/interface/panelsettingspage.cpp
-        panels/information/informationpanel.h
-        panels/information/informationpanelcontent.h
-        panels/information/pixmapviewer.h
-        panels/information/mediawidget.h
-        settings/interface/panelsettingspage.h
-    )
-
-    kconfig_add_kcfg_files(dolphinstatic
-        panels/information/dolphin_informationpanelsettings.kcfgc
-    )
-
-    target_link_libraries(dolphinstatic
-        Qt::Multimedia
-        Qt::MultimediaWidgets
-    )
-endif()
-
 if(HAVE_KUSERFEEDBACK)
     target_sources(dolphinstatic PRIVATE
         userfeedback/dolphinfeedbackprovider.cpp
@@ -459,6 +447,7 @@ endif()
 
 kconfig_add_kcfg_files(dolphinstatic
     panels/folders/dolphin_folderspanelsettings.kcfgc
+    panels/information/dolphin_informationpanelsettings.kcfgc
     panels/places/dolphin_placespanelsettings.kcfgc
     settings/dolphin_compactmodesettings.kcfgc
     settings/dolphin_detailsmodesettings.kcfgc
diff --git a/src/dolphinmainwindow.cpp b/src/dolphinmainwindow.cpp
index 78560d820..ebcddf424 100644
--- a/src/dolphinmainwindow.cpp
+++ b/src/dolphinmainwindow.cpp
@@ -2274,7 +2274,6 @@ void DolphinMainWindow::setupDockWidgets()
     infoDock->setObjectName(QStringLiteral("infoDock"));
     infoDock->setAllowedAreas(Qt::LeftDockWidgetArea | Qt::RightDockWidgetArea);
 
-#if HAVE_BALOO
     InformationPanel *infoPanel = new InformationPanel(infoDock);
     infoPanel->setCustomContextMenuActions({lockLayoutAction});
     connect(infoPanel, &InformationPanel::urlActivated, this, &DolphinMainWindow::handleUrl);
@@ -2288,14 +2287,12 @@ void DolphinMainWindow::setupDockWidgets()
     connect(this, &DolphinMainWindow::requestItemInfo, infoPanel, &InformationPanel::requestDelayedItemInfo);
     connect(this, &DolphinMainWindow::fileItemsChanged, infoPanel, &InformationPanel::slotFilesItemChanged);
     connect(this, &DolphinMainWindow::settingsChanged, infoPanel, &InformationPanel::readSettings);
-#endif
 
     // i18n: This is the last paragraph for the "What's This"-texts of all four panels.
     const QString panelWhatsThis = xi18nc("@info:whatsthis",
                                           "<para>To show or "
                                           "hide panels like this go to <interface>Menu|Panels</interface> "
                                           "or <interface>View|Panels</interface>.</para>");
-#if HAVE_BALOO
     actionCollection()
         ->action(QStringLiteral("show_information_panel"))
         ->setWhatsThis(xi18nc("@info:whatsthis",
@@ -2305,7 +2302,6 @@ void DolphinMainWindow::setupDockWidgets()
                               "about the items your mouse is hovering over or about the selected "
                               "items. Otherwise it informs you about the currently viewed folder.<nl/>"
                               "For single items a preview of their contents is provided.</para>"));
-#endif
     infoDock->setWhatsThis(xi18nc("@info:whatsthis",
                                   "<para>This panel "
                                   "provides in-depth information about the items your mouse is "
@@ -2486,9 +2482,7 @@ void DolphinMainWindow::setupDockWidgets()
     panelsMenu->setPopupMode(QToolButton::InstantPopup);
     const KActionCollection *ac = actionCollection();
     panelsMenu->addAction(ac->action(QStringLiteral("show_places_panel")));
-#if HAVE_BALOO
     panelsMenu->addAction(ac->action(QStringLiteral("show_information_panel")));
-#endif
     panelsMenu->addAction(ac->action(QStringLiteral("show_folders_panel")));
     panelsMenu->addAction(ac->action(QStringLiteral("show_terminal_panel")));
     panelsMenu->addSeparator();
diff --git a/src/dolphinmainwindow.h b/src/dolphinmainwindow.h
index 8b9c4a211..cb22d6929 100644
--- a/src/dolphinmainwindow.h
+++ b/src/dolphinmainwindow.h
@@ -18,9 +18,7 @@
 #include <kio/fileundomanager.h>
 #include <kxmlguiwindow.h>
 
-#if HAVE_BALOO
 #include "panels/information/informationpanel.h"
-#endif
 
 #include <QFutureWatcher>
 #include <QIcon>
diff --git a/src/panels/information/informationpanel.cpp b/src/panels/information/informationpanel.cpp
index 8adb64ff0..7e28ec48e 100644
--- a/src/panels/information/informationpanel.cpp
+++ b/src/panels/information/informationpanel.cpp
@@ -16,7 +16,9 @@
 #include <KJobWidgets>
 #include <KLocalizedString>
 
+#if HAVE_BALOO
 #include <Baloo/FileMetaDataWidget>
+#endif
 
 #include <QApplication>
 #include <QMenu>
@@ -153,6 +155,7 @@ void InformationPanel::showContextMenu(const QPoint &pos)
 {
     QMenu popup(this);
 
+#if HAVE_BALOO
     QAction *previewAction = popup.addAction(i18nc("@action:inmenu", "Preview"));
     previewAction->setIcon(QIcon::fromTheme(QStringLiteral("view-preview")));
     previewAction->setCheckable(true);
@@ -180,6 +183,8 @@ void InformationPanel::showContextMenu(const QPoint &pos)
     dateformatAction->setChecked(InformationPanelSettings::dateFormat() == static_cast<int>(Baloo::DateFormats::ShortFormat));
 
     popup.addSeparator();
+#endif
+
     const auto actions = customContextMenuActions();
     for (QAction *action : actions) {
         popup.addAction(action);
@@ -192,6 +197,7 @@ void InformationPanel::showContextMenu(const QPoint &pos)
         return;
     }
 
+#if HAVE_BALOO
     const bool isChecked = action->isChecked();
     if (action == previewAction) {
         InformationPanelSettings::setPreviewsShown(isChecked);
@@ -214,6 +220,7 @@ void InformationPanel::showContextMenu(const QPoint &pos)
         InformationPanelSettings::setDateFormat(dateFormat);
         m_content->refreshMetaData();
     }
+#endif
 }
 
 void InformationPanel::showItemInfo()
diff --git a/src/panels/information/informationpanelcontent.cpp b/src/panels/information/informationpanelcontent.cpp
index 134c5e056..f5d9a6309 100644
--- a/src/panels/information/informationpanelcontent.cpp
+++ b/src/panels/information/informationpanelcontent.cpp
@@ -18,11 +18,18 @@
 #include <KStringHandler>
 #include <QPainterPath>
 
+#if HAVE_BALOO
+#else
+#include <KFileItem>
+#endif
+
 #include <QIcon>
 #include <QStyle>
 #include <QTextDocument>
 
+#if HAVE_BALOO
 #include <Baloo/FileMetaDataWidget>
+#endif
 
 #include <QDialogButtonBox>
 #include <QGesture>
@@ -51,7 +58,9 @@ InformationPanelContent::InformationPanelContent(QWidget *parent)
     , m_preview(nullptr)
     , m_mediaWidget(nullptr)
     , m_nameLabel(nullptr)
+#if HAVE_BALOO
     , m_metaDataWidget(nullptr)
+#endif
     , m_metaDataArea(nullptr)
     , m_isVideo(false)
 {
@@ -93,6 +102,7 @@ InformationPanelContent::InformationPanelContent(QWidget *parent)
     const bool previewsShown = InformationPanelSettings::previewsShown();
     m_preview->setVisible(previewsShown);
 
+#if HAVE_BALOO
     m_metaDataWidget = new Baloo::FileMetaDataWidget(parent);
     m_metaDataWidget->setDateFormat(static_cast<Baloo::DateFormats>(InformationPanelSettings::dateFormat()));
     connect(m_metaDataWidget, &Baloo::FileMetaDataWidget::urlActivated, this, &InformationPanelContent::urlActivated);
@@ -118,9 +128,12 @@ InformationPanelContent::InformationPanelContent(QWidget *parent)
         m_configureLabel->setVisible(false);
         Q_EMIT configurationFinished();
     });
+#endif
 
     m_metaDataArea = new QScrollArea(parent);
+#if HAVE_BALOO
     m_metaDataArea->setWidget(m_metaDataWidget);
+#endif
     m_metaDataArea->setWidgetResizable(true);
     m_metaDataArea->setFrameShape(QFrame::NoFrame);
 
@@ -132,9 +145,13 @@ InformationPanelContent::InformationPanelContent(QWidget *parent)
     layout->addWidget(m_mediaWidget);
     layout->addWidget(m_nameLabel);
     layout->addWidget(new KSeparator());
+#if HAVE_BALOO
     layout->addWidget(m_configureLabel);
+#endif
     layout->addWidget(m_metaDataArea);
+#if HAVE_BALOO
     layout->addWidget(m_configureButtons);
+#endif
 
     grabGesture(Qt::TapAndHoldGesture);
 }
@@ -258,16 +275,20 @@ void InformationPanelContent::refreshPreview()
 
 void InformationPanelContent::configureShownProperties()
 {
+#if HAVE_BALOO
     m_configureLabel->setVisible(true);
     m_configureButtons->setVisible(true);
     m_metaDataWidget->setConfigurationMode(Baloo::ConfigurationMode::ReStart);
+#endif
 }
 
 void InformationPanelContent::refreshMetaData()
 {
+#if HAVE_BALOO
     m_metaDataWidget->setDateFormat(static_cast<Baloo::DateFormats>(InformationPanelSettings::dateFormat()));
     m_metaDataWidget->show();
     m_metaDataWidget->setItems(KFileItemList() << m_item);
+#endif
 }
 
 void InformationPanelContent::showItems(const KFileItemList &items)
@@ -283,7 +304,9 @@ void InformationPanelContent::showItems(const KFileItemList &items)
     m_preview->setPixmap(QIcon::fromTheme(QStringLiteral("dialog-information")).pixmap(m_preview->height(), m_preview->width()));
     setNameLabelText(i18ncp("@label", "%1 item selected", "%1 items selected", items.count()));
 
+#if HAVE_BALOO
     m_metaDataWidget->setItems(items);
+#endif
 
     m_mediaWidget->hide();
 
@@ -295,13 +318,17 @@ bool InformationPanelContent::eventFilter(QObject *obj, QEvent *event)
     switch (event->type()) {
     case QEvent::Resize: {
         QResizeEvent *resizeEvent = static_cast<QResizeEvent *>(event);
+#if HAVE_BALOO
         if (obj == m_metaDataArea->viewport()) {
             // The size of the meta text area has changed. Adjust the fixed
             // width in a way that no horizontal scrollbar needs to be shown.
             m_metaDataWidget->setFixedWidth(resizeEvent->size().width());
         } else if (obj == parent()) {
+#endif
             adjustWidgetSizes(resizeEvent->size().width());
+#if HAVE_BALOO
         }
+#endif
         break;
     }
 
@@ -309,9 +336,11 @@ bool InformationPanelContent::eventFilter(QObject *obj, QEvent *event)
         adjustWidgetSizes(parentWidget()->width());
         break;
 
+#if HAVE_BALOO
     case QEvent::FontChange:
         m_metaDataWidget->setFont(QFontDatabase::systemFont(QFontDatabase::SmallestReadableFont));
         break;
+#endif
 
     default:
         break;
@@ -434,7 +463,11 @@ void InformationPanelContent::markOutdatedPreview()
 
 KFileItemList InformationPanelContent::items()
 {
+#if HAVE_BALOO
     return m_metaDataWidget->items();
+#else
+    return KFileItemList();
+#endif
 }
 
 void InformationPanelContent::slotHasVideoChanged(bool hasVideo)
@@ -495,7 +528,9 @@ void InformationPanelContent::adjustWidgetSizes(int width)
 
     // The metadata widget also contains a text widget which may return
     // a large preferred width.
+#if HAVE_BALOO
     m_metaDataWidget->setMaximumWidth(maxWidth);
+#endif
 
     // try to increase the preview as large as possible
     m_preview->setSizeHint(QSize(maxWidth, maxWidth));
diff --git a/src/panels/information/informationpanelcontent.h b/src/panels/information/informationpanelcontent.h
index 333b26608..2f62d19d2 100644
--- a/src/panels/information/informationpanelcontent.h
+++ b/src/panels/information/informationpanelcontent.h
@@ -147,10 +147,14 @@ private:
     PixmapViewer *m_preview;
     MediaWidget *m_mediaWidget;
     QLabel *m_nameLabel;
+#if HAVE_BALOO
     Baloo::FileMetaDataWidget *m_metaDataWidget;
+#endif
     QScrollArea *m_metaDataArea;
+#if HAVE_BALOO
     QLabel *m_configureLabel;
     QDialogButtonBox *m_configureButtons;
+#endif
 
     bool m_isVideo;
 };
-- 
2.49.1

