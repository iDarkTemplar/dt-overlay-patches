From 0f4fac733c1e8a50704df6bcf87f07d5d14458bf Mon Sep 17 00:00:00 2001
From: "i.Dark_Templar" <darktemplar@dark-templar-archives.net>
Date: Sun, 24 May 2020 14:01:51 +0300
Subject: [PATCH] skins-qt: allow dropping files into playlist

---
 src/skins-qt/playlist-widget.cc | 36 +++++++++++++++++++++++++++++++++
 src/skins-qt/playlist-widget.h  |  2 ++
 2 files changed, 38 insertions(+)

diff --git a/src/skins-qt/playlist-widget.cc b/src/skins-qt/playlist-widget.cc
index ff6e5ffff..854bb6af3 100644
--- a/src/skins-qt/playlist-widget.cc
+++ b/src/skins-qt/playlist-widget.cc
@@ -34,12 +34,15 @@
 #include "playlist-slider.h"
 
 #include <libaudcore/audstrings.h>
+#include <libaudcore/drct.h>
 #include <libaudcore/hook.h>
 #include <libaudcore/i18n.h>
 #include <libaudcore/runtime.h>
 #include <libaudcore/playlist.h>
 #include <libaudqt/libaudqt.h>
 
+#include <QMimeData>
+
 enum {
     DRAG_SELECT = 1,
     DRAG_MOVE
@@ -279,6 +282,8 @@ PlaylistWidget::PlaylistWidget (int width, int height, const char * font) :
 {
     add_input (m_width, m_height, true, true);
     set_font (font);  /* calls refresh() */
+
+    setAcceptDrops(true);
 }
 
 void PlaylistWidget::resize (int width, int height)
@@ -738,6 +743,37 @@ bool PlaylistWidget::motion (QMouseEvent * event)
     return true;
 }
 
+void PlaylistWidget::dragEnterEvent (QDragEnterEvent * event)
+{
+    const QMimeData * mimedata = event->mimeData();
+
+    if (mimedata->hasUrls())
+    {
+        event->setAccepted(true);
+    }
+}
+
+void PlaylistWidget::dropEvent (QDropEvent * event)
+{
+    int position = calc_position (event->pos().y());
+    const QMimeData * mimedata = event->mimeData();
+
+    if (mimedata->hasUrls())
+    {
+        Index<PlaylistAddItem> files;
+
+        for (const auto &url: mimedata->urls())
+        {
+            if (url.isLocalFile())
+                files.append(String(url.toString().toLocal8Bit().data()));
+        }
+
+        aud_drct_pl_add_list (std::move (files), (position >= 0) ? position : 0);
+    }
+
+    event->acceptProposedAction();
+}
+
 bool PlaylistWidget::leave ()
 {
     if (! m_drag)
diff --git a/src/skins-qt/playlist-widget.h b/src/skins-qt/playlist-widget.h
index 3b2811450..fdde20269 100644
--- a/src/skins-qt/playlist-widget.h
+++ b/src/skins-qt/playlist-widget.h
@@ -60,6 +60,8 @@ private:
     bool button_press (QMouseEvent * event);
     bool button_release (QMouseEvent * event);
     bool motion (QMouseEvent * event);
+    void dragEnterEvent (QDragEnterEvent * event) override;
+    void dropEvent (QDropEvent * event) override;
     bool leave ();
 
     void update_title ();
-- 
2.26.2

